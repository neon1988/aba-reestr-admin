import{r as z,k as h,g as X,z as te,C as Y,t as ue,h as Q,c as ae,an as le,y as ne,N as ie,W as _,a8 as K,Q as re,O as se,o as oe,_ as de,R as ce,S as $,T as W,U as S,X as O,V as f,Y as fe,a4 as me,$ as ve}from"./index-DjZidwi3.js";import{a as ge,Q as pe}from"./QToolbar-BiMzdSH1.js";import{o as he,Q as be}from"./ImageFullscreen-D_JowLWA.js";import{Q as ye}from"./QChip-DwiTiQpv.js";import{b as Fe,u as Ce,c as Se,d as Ve,e as Qe,f as ze,g as H,h as ke,Q as Ne}from"./QInput-CHeOjWWK.js";import{Q as M}from"./QCardSection-d4ebZ8Jd.js";import{Q as Pe}from"./QForm-BnAiDf7r.js";import{Q as De,a as we}from"./QInnerLoading-DA1P_EJf.js";import{Q as xe}from"./QPage-BFCFRqG0.js";import{u as Ae,a as Ee,b as Ie}from"./users-Bpn_3JQb.js";import{u as Ue}from"./use-quasar-7GJOWN87.js";import{U as _e}from"./UserPhoto-DjNUlehv.js";import"./focus-manager-zjdVGI5d.js";import"./use-dark-D_lfRTDq.js";function w(e,n,m,F){const a=[];return e.forEach(r=>{F(r)===!0?a.push(r):n.push({failedPropValidation:m,file:r})}),a}function U(e){e&&e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),Y(e)}const qe={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Te=["rejected"];function je({editable:e,dnd:n,getFileInput:m,addFilesToQueue:F}){const{props:a,emit:r,proxy:v}=X(),d=z(null),k=h(()=>a.accept!==void 0?a.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),N=h(()=>parseInt(a.maxFiles,10)),P=h(()=>parseInt(a.maxTotalSize,10));function D(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&te(t);else{const y=m();y&&y!==t.target&&y.click(t)}}function c(t){e.value&&t&&F(null,t)}function g(t,y,x,A){let l=Array.from(y||t.target.files);const b=[],V=()=>{b.length!==0&&r("rejected",b)};if(a.accept!==void 0&&k.value.indexOf("*/")===-1&&(l=w(l,b,"accept",i=>k.value.some(o=>i.type.toUpperCase().startsWith(o)||i.name.toUpperCase().endsWith(o))),l.length===0))return V();if(a.maxFileSize!==void 0){const i=parseInt(a.maxFileSize,10);if(l=w(l,b,"max-file-size",o=>o.size<=i),l.length===0)return V()}if(a.multiple!==!0&&l.length!==0&&(l=[l[0]]),l.forEach(i=>{i.__key=i.webkitRelativePath+i.lastModified+i.name+i.size}),A===!0){const i=x.map(o=>o.__key);l=w(l,b,"duplicate",o=>i.includes(o.__key)===!1)}if(l.length===0)return V();if(a.maxTotalSize!==void 0){let i=A===!0?x.reduce((o,j)=>o+j.size,0):0;if(l=w(l,b,"max-total-size",o=>(i+=o.size,i<=P.value)),l.length===0)return V()}if(typeof a.filter=="function"){const i=a.filter(l);l=w(l,b,"filter",o=>i.includes(o))}if(a.maxFiles!==void 0){let i=A===!0?x.length:0;if(l=w(l,b,"max-files",()=>(i++,i<=N.value)),l.length===0)return V()}if(V(),l.length!==0)return l}function q(t){U(t),n.value!==!0&&(n.value=!0)}function s(t){Y(t),(t.relatedTarget!==null||ue.is.safari!==!0?t.relatedTarget!==d.value:document.elementsFromPoint(t.clientX,t.clientY).includes(d.value)===!1)===!0&&(n.value=!1)}function E(t){U(t);const y=t.dataTransfer.files;y.length!==0&&F(null,y),n.value=!1}function T(t){if(n.value===!0)return Q("div",{ref:d,class:`q-${t}__dnd absolute-full`,onDragenter:U,onDragover:U,onDragleave:s,onDrop:E})}return Object.assign(v,{pickFiles:D,addFiles:c}),{pickFiles:D,addFiles:c,onDragover:q,onDragleave:s,processFiles:g,getDndNode:T,maxFilesNumber:N,maxTotalSizeNumber:P}}const G=ae({name:"QFile",inheritAttrs:!1,props:{...Fe,...Ce,...qe,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...Se,...Te],setup(e,{slots:n,emit:m,attrs:F}){const{proxy:a}=X(),r=Ve(),v=z(null),d=z(!1),k=Qe(e),{pickFiles:N,onDragover:P,onDragleave:D,processFiles:c,getDndNode:g}=je({editable:r.editable,dnd:d,getFileInput:R,addFilesToQueue:L}),q=ze(e),s=h(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),E=h(()=>H(s.value)),T=h(()=>s.value.map(u=>u.name).join(", ")),t=h(()=>he(s.value.reduce((u,p)=>u+p.size,0))),y=h(()=>({totalSize:t.value,filesNumber:s.value.length,maxFiles:e.maxFiles})),x=h(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:k.value,...F,id:r.targetUid.value,disabled:r.editable.value!==!0})),A=h(()=>"q-file q-field--auto-height"+(d.value===!0?" q-file--dnd":"")),l=h(()=>e.multiple===!0&&e.append===!0);function b(u){const p=s.value.slice();p.splice(u,1),i(p)}function V(u){const p=s.value.indexOf(u);p!==-1&&b(p)}function i(u){m("update:modelValue",e.multiple===!0?u:u[0])}function o(u){u.keyCode===13&&ne(u)}function j(u){(u.keyCode===13||u.keyCode===32)&&N(u)}function R(){return v.value}function L(u,p){const C=c(u,p,s.value,l.value),B=R();B!=null&&(B.value=""),C!==void 0&&((e.multiple===!0?e.modelValue&&C.every(ee=>s.value.includes(ee)):e.modelValue===C[0])||i(l.value===!0?s.value.concat(C):C))}function I(){return[Q("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function J(){if(n.file!==void 0)return s.value.length===0?I():s.value.map((p,C)=>n.file({index:C,file:p,ref:this}));if(n.selected!==void 0)return s.value.length===0?I():n.selected({files:s.value,ref:this});if(e.useChips===!0)return s.value.length===0?I():s.value.map((p,C)=>Q(ye,{key:"file-"+C,removable:r.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{b(C)}},()=>Q("span",{class:"ellipsis",textContent:p.name})));const u=e.displayValue!==void 0?e.displayValue:T.value;return u.length!==0?[Q("div",{class:e.inputClass,style:e.inputStyle,textContent:u})]:I()}function Z(){const u={ref:v,...x.value,...q.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:L};return e.multiple===!0&&(u.multiple=!0),Q("input",u)}return Object.assign(r,{fieldClass:A,emitValue:i,hasValue:E,inputRef:v,innerValue:s,floatingLabel:h(()=>E.value===!0||H(e.displayValue)),computedCounter:h(()=>{if(e.counterLabel!==void 0)return e.counterLabel(y.value);const u=e.maxFiles;return`${s.value.length}${u!==void 0?" / "+u:""} (${t.value})`}),getControlChild:()=>g("file"),getControl:()=>{const u={ref:r.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return r.editable.value===!0&&Object.assign(u,{onDragover:P,onDragleave:D,onKeydown:o,onKeyup:j}),Q("div",u,[Z()].concat(J()))}}),Object.assign(a,{removeAtIndex:b,removeFile:V,getNativeElement:()=>v.value}),le(a,"nativeEl",()=>v.value),ke(r)}}),Be=ie({props:{id:{type:Number,required:!0}},components:{UserPhoto:_e,QFile:G,QBtn:_,QAvatar:K},setup(e){const n=re(),m=se(),F=Ue(),a=z(!1),r=z(null),v=z(null),d=z(null),k=c=>{const g=new FileReader;g.onloadend=()=>{g.result&&(d.value=g.result)},c&&g.readAsDataURL(c)},N=async c=>{if(v.value){a.value=!0;try{const g=await Ae(c,v.value);r.value=g.data.user,F.notify({message:g.data.message,color:"positive",position:"top",timeout:3e3}),e.id&&m.user&&m.user.id===e.id&&await m.fetchUser()}finally{a.value=!1}}},P=async c=>{a.value=!0;try{const g=await Ee(c);r.value=g.data.data}finally{a.value=!1}},D=async()=>{if(r.value){a.value=!0;try{const c=await Ie(e.id,r.value);r.value=c.data.user,F.notify({message:c.data.message,color:"positive",position:"top",timeout:3e3}),e.id&&m.user&&m.user.id===e.id&&await m.fetchUser()}finally{a.value=!1}}};return oe(()=>{e.id&&P(e.id)}),{loading:a,user:r,photo:v,saveChangesHandler:D,imagePreview:d,handleFileChange:k,uploadImage:N,router:n}}}),$e={key:0,class:"q-mb-md text-center"},Oe=["src"];function Re(e,n,m,F,a,r){const v=ce("user-photo");return e.user?($(),W(xe,{key:0,padding:""},{default:S(()=>[f(pe,null,{default:S(()=>[f(_,{flat:"",icon:"arrow_back",onClick:n[0]||(n[0]=d=>e.router.go(-1))}),f(ge,null,{default:S(()=>n[4]||(n[4]=[fe("Редактировать профиль")])),_:1})]),_:1}),f(M,null,{default:S(()=>[f(be,{avatar:"",class:"q-mb-lg"},{default:S(()=>[f(v,{user:e.user,fullscreen:!0,size:"5rem",class:"cursor-pointer",width:100,height:100},null,8,["user"])]),_:1}),f(G,{filled:"",modelValue:e.photo,"onUpdate:modelValue":n[1]||(n[1]=d=>e.photo=d),label:"Выберите изображение",onAdded:e.handleFileChange,accept:"image/*",class:"q-mb-md"},null,8,["modelValue","onAdded"]),e.imagePreview?($(),me("div",$e,[f(K,{size:"150px",class:"q-mb-md"},{default:S(()=>[ve("img",{src:e.imagePreview,alt:"Предварительный просмотр"},null,8,Oe)]),_:1})])):O("",!0),f(_,{label:"Загрузить изображение",color:"primary",onClick:n[2]||(n[2]=d=>e.uploadImage(e.user.id)),disabled:!e.photo},null,8,["disabled"])]),_:1}),e.user?($(),W(M,{key:0},{default:S(()=>[f(Pe,{onSubmit:e.saveChangesHandler,ref:"form"},{default:S(()=>[f(Ne,{modelValue:e.user.name,"onUpdate:modelValue":n[3]||(n[3]=d=>e.user.name=d),outlined:"",label:"Имя",class:"q-mb-md"},null,8,["modelValue"]),f(_,{type:"submit",label:"Сохранить изменения",color:"primary",class:"full-width q-mt-md"})]),_:1},8,["onSubmit"])]),_:1})):O("",!0),f(we,{showing:e.loading},{default:S(()=>[f(De,{size:"5rem",color:"primary"})]),_:1},8,["showing"])]),_:1})):O("",!0)}const lt=de(Be,[["render",Re],["__file","EditPage.vue"]]);export{lt as default};
